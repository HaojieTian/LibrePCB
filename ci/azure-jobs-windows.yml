jobs:
- job: Windows
  pool:
    vmImage: 'ubuntu-16.04'
  variables:
    OS: 'windows'
    ARCH: 'x86'
  strategy:
    matrix:
      Qt_5_14_1_MINGW:
        IMAGE: librepcb/librepcb-dev:wine-1
        WINEPATH: "C:\\Qt\\5.14.1\\mingw73_32\\bin;C:\\Qt\\Tools\\mingw730_32\\bin"
        DEPLOY: true
  container: $[ variables['IMAGE'] ]
  steps:
  - checkout: self
    clean: true
    submodules: recursive
  - bash: mkdir ~/.wine && ln -s /drive_c ~/.wine/drive_c
    displayName: Configure Wine
#  - bash: |
#      source ./ci/install_dependencies.sh
#      # Pass modified PATH to following steps:
#      echo "##vso[task.setvariable variable=PATH]$PATH"
#    displayName: Install Dependencies
  - bash: ./ci/build_librepcb.sh
    displayName: Build LibrePCB
  - bash: ./ci/build_windows_archive.sh
    displayName: Build Archive
    condition: and(succeeded(), eq(variables['DEPLOY'], 'true'))
#  - bash: ./ci/build_installer.sh
#    displayName: Build Installer
#    condition: and(succeeded(), eq(variables['DEPLOY'], 'true'))
#  - bash: xvfb-run -a ./build/output/qztest
#    displayName: Run QuaZip Unittests
#  - bash: xvfb-run -a ./build/output/librepcb-unittests
#    displayName: Run LibrePCB Unittests
#  - bash: xvfb-run -a --server-args="-screen 0 1024x768x24" pytest -v --librepcb-executable="build/install/opt/bin/librepcb-cli" ./tests/cli
#    displayName: Run LibrePCB-CLI Functional Tests
#  - bash: xvfb-run -a --server-args="-screen 0 1024x768x24" pytest -v --librepcb-executable="build/install/opt/bin/librepcb" ./tests/funq
#    displayName: Run LibrePCB Functional Tests
  - bash: ./ci/upload_artifacts.sh
    displayName: Upload Artifacts
    condition: and(succeeded(), eq(variables['DEPLOY'], 'true'), ne(variables['Build.Reason'], 'PullRequest'))
    env:
      UPLOAD_URL: $(ARTIFACTS_UPLOAD_URL)
      UPLOAD_USER: $(ARTIFACTS_UPLOAD_USER)
      UPLOAD_PASS: $(ARTIFACTS_UPLOAD_PASS)
      UPLOAD_SIGN_KEY: $(ARTIFACTS_UPLOAD_SIGN_KEY)
